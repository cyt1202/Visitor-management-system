<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>My Reservations</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50">

    <nav class="bg-white shadow mb-8">
        <div class="container mx-auto px-6 py-4">
            <a href="visitor_home.html" class="text-blue-600 hover:underline font-bold">&larr; Back to Home</a>
        </div>
    </nav>

    <div class="container mx-auto px-6">
        <h2 class="text-2xl font-bold mb-6 text-gray-800">My Reservations</h2>

        <div class="bg-white rounded-lg shadow overflow-hidden">
            <table class="w-full text-left border-collapse">
                <thead>
                    <tr class="bg-gray-100 text-gray-600 text-sm">
                        <th class="p-4 border-b">Date</th>
                        <th class="p-4 border-b">Time</th>
                        <th class="p-4 border-b">Location</th>
                        <th class="p-4 border-b">Purpose</th>
                        <th class="p-4 border-b">Status</th>
                        <th class="p-4 border-b">Actions</th>
                    </tr>
                </thead>
                <tbody id="resTableBody">
                    </tbody>
            </table>
            <p id="emptyMsg" class="text-center py-8 text-gray-500 hidden">No reservation records found</p>
        </div>
    </div>

    <div id="editModal" class="fixed inset-0 bg-gray-900 bg-opacity-50 hidden flex items-center justify-center">
        <div class="bg-white p-6 rounded-lg shadow-lg w-96">
            <h3 class="text-xl font-bold mb-4">Edit Reservation</h3>
            <p class="text-xs text-red-500 mb-4">Note: After modification, status will be reset to "Pending Approval".</p>
            
            <input type="hidden" id="editId">
            <div class="mb-3">
                <label class="block text-xs font-bold mb-1">Date</label>
                <input type="date" id="editDate" class="w-full border p-2 rounded">
            </div>
            <div class="mb-3">
                <label class="block text-xs font-bold mb-1">Time</label>
                <input type="time" id="editTime" class="w-full border p-2 rounded">
            </div>
            <div class="mb-3">
                <label class="block text-xs font-bold mb-1">Location</label>
                <input type="text" id="editLocation" class="w-full border p-2 rounded">
            </div>
            <div class="mb-4">
                <label class="block text-xs font-bold mb-1">Purpose</label>
                <textarea id="editPurpose" class="w-full border p-2 rounded"></textarea>
            </div>

            <div class="flex justify-end gap-2">
                <button onclick="closeModal()" class="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded">Cancel</button>
                <button onclick="saveChanges()" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">Save Changes</button>
            </div>
        </div>
    </div>

    <script>
        const userId = localStorage.getItem('user_id');
        const token = localStorage.getItem('token');

        // 1. Fetch reservation list when page loads
        window.onload = function() {
            fetch(`/api/reservations?user_id=${userId}`, {
                headers: { 'Authorization': 'Bearer ' + token }
            })
            .then(res => res.json())
            .then(data => renderTable(data))
            .catch(err => console.error(err));
        };

        function renderTable(data) {
            const tbody = document.getElementById('resTableBody');
            tbody.innerHTML = '';

            if (data.length === 0) {
                document.getElementById('emptyMsg').classList.remove('hidden');
                return;
            }

            data.forEach(item => {
                // Status color mapping
                const statusColors = {
                    'pending': 'bg-yellow-100 text-yellow-800',
                    'approved': 'bg-green-100 text-green-800',
                    'rejected': 'bg-red-100 text-red-800'
                };
                const badgeClass = statusColors[item.status] || 'bg-gray-100';

                // Status display text
                const statusText = {
                    'pending': 'Pending',
                    'approved': 'Approved', 
                    'rejected': 'Rejected'
                };

                const row = `
                    <tr class="hover:bg-gray-50 border-b">
                        <td class="p-4">${item.visit_date}</td>
                        <td class="p-4">${item.visit_time}</td>
                        <td class="p-4">${item.location}</td>
                        <td class="p-4 text-gray-500 text-sm">${item.purpose}</td>
                        <td class="p-4"><span class="px-2 py-1 rounded text-xs font-bold ${badgeClass}">${statusText[item.status] || item.status}</span></td>
                        <td class="p-4 flex gap-2">
                            <button onclick='openModal(${JSON.stringify(item)})' class="text-blue-600 text-sm hover:underline">Edit</button>
                            <button onclick="deleteRes(${item.reservation_id})" class="text-red-600 text-sm hover:underline">Cancel</button>
                        </td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });
        }

        // 2. Delete reservation
        function deleteRes(id) {
            if(!confirm("Are you sure you want to cancel this reservation?")) return;
            
            fetch(`/api/reservations/${id}`, {
                method: 'DELETE',
                headers: { 'Authorization': 'Bearer ' + token }
            }).then(res => {
                if(res.ok) window.location.reload(); // Refresh page
            });
        }

        // 3. Edit logic - Open modal
        function openModal(item) {
            document.getElementById('editId').value = item.reservation_id;
            document.getElementById('editDate').value = item.visit_date;
            document.getElementById('editTime').value = item.visit_time;
            document.getElementById('editLocation').value = item.location;
            document.getElementById('editPurpose').value = item.purpose;
            document.getElementById('editModal').classList.remove('hidden');
        }

        function closeModal() {
            document.getElementById('editModal').classList.add('hidden');
        }

        // 4. Edit logic - Save changes
        function saveChanges() {
            const id = document.getElementById('editId').value;
            const body = {
                date: document.getElementById('editDate').value,
                time: document.getElementById('editTime').value,
                location: document.getElementById('editLocation').value,
                purpose: document.getElementById('editPurpose').value
            };

            fetch(`/api/reservations/${id}`, {
                method: 'PUT',
                headers: { 
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer ' + token
                },
                body: JSON.stringify(body)
            }).then(res => {
                if(res.ok) {
                    alert("Reservation updated successfully! Status has been reset to Pending Approval.");
                    window.location.reload();
                }
            });
        }
    </script>
</body>
</html>